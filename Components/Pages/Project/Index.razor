@page "/projects"

@rendermode InteractiveServer

@inject IProjectRepository ProjectRepo

@attribute [StreamRendering]
@attribute [Authorize]

<PageTitle>Projects - Zing</PageTitle>

<div class="row">
    <div class="col">
        <HeadingTitle Title="Projects"></HeadingTitle>
    </div>
    <div class="col-auto align-content-center">
        <div class="d-flex">
            <ProjectManager OnPush="CreateProject"></ProjectManager>
        </div>
        <br />
    </div>
</div>

@if (Projects is null)
{
    <div class="d-flex flex-column justify-content-center align-items-center h-100">
        <Spinner Type="SpinnerType.Dots" Color="SpinnerColor.Primary" Size="SpinnerSize.Large" />
    </div>
}
else
{
    <Tabs EnableFadeEffect="true" NavStyle="NavStyle.Underline">
        <Tab Title="@($"All ({Projects.Count})")" Active="true">
            <Content>
                <br />
                <ProjectsGrider Data="Projects"></ProjectsGrider>
            </Content>
        </Tab>
        <Tab Title="@($"Pending ({ProjectsPending.Count})")" Disabled="!ProjectsPending.Any()">
            <Content>
                <br />
                <ProjectsGrider Data="ProjectsPending"></ProjectsGrider>
            </Content>
        </Tab>
        <Tab Title="@($"Waiting ({ProjectsWaiting.Count})")" Disabled="!ProjectsWaiting.Any()">
            <Content>
                <br />
                <ProjectsGrider Data="ProjectsWaiting"></ProjectsGrider>
            </Content>
        </Tab>
        <Tab Title="@($"Approved ({ProjectsApproved.Count})")" Disabled="!ProjectsApproved.Any()">
            <Content>
                <br />
                <ProjectsGrider Data="ProjectsApproved"></ProjectsGrider>
            </Content>
        </Tab>
        <Tab Title="@($"Rejected ({ProjectsRejected.Count})")" Disabled="!ProjectsRejected.Any()">
            <Content>
                <br />
                <ProjectsGrider Data="ProjectsRejected"></ProjectsGrider>
            </Content>
        </Tab>
        <Tab Title="@($"Completed ({ProjectsCompleted.Count})")" Disabled="!ProjectsCompleted.Any()">
            <Content>
                <br />
                <ProjectsGrider Data="ProjectsCompleted"></ProjectsGrider>
            </Content>
        </Tab>
    </Tabs>
}

@code {
    [Inject] protected ToastService ToastService { get; set; } = default!;

    // Cascading parameter to get the current authentication state
    [CascadingParameter]
    private Task<AuthenticationState> authenticationState { get; set; }

    private List<Project> Projects = default!;
    private List<Project> ProjectsPending = new();
    private List<Project> ProjectsApproved = new();
    private List<Project> ProjectsRejected = new();
    private List<Project> ProjectsWaiting = new();
    private List<Project> ProjectsCompleted = new();

    private List<ApplicationUser> OperationUsers { get; set; } = new();
    private List<Client> Clients { get; set; } = new();

    private string UserId { get; set; }
    private List<string> Roles { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var authState = await authenticationState;
        Roles = authState.User.Claims.Where(c => c.Type == ClaimTypes.Role).Select(c => c.Value).ToList();
        UserId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        await GetProjects();
    }

    private async Task GetProjects()
    {
        try
        {
            if (Roles.Contains(SD.Role_ClientService))
            {
                Projects = await ProjectRepo.GetAllAsync(
                    filter: f => f.UserId.Equals(UserId),
                    orderBy: p => p.Number,
                    ascending: false,
                    includeProperties: "User,OperationUser,Client"); // call a service or an API to pull the Projects
            }
            else if (Roles.Contains(SD.Role_OperationManager))
            {
                Projects = await ProjectRepo.GetAllAsync(
                    filter: f => f.OperationUserId.Equals(UserId),
                    orderBy: p => p.Number,
                    ascending: false,
                    includeProperties: "User,OperationUser,Client"); // call a service or an API to pull the Projects
            }
            else
            {
                Projects = await ProjectRepo.GetAllAsync(
                    orderBy: p => p.Number,
                    ascending: false,
                    includeProperties: "User,OperationUser,Client"); // call a service or an API to pull the Projects
            }
        }
        catch
        {
            // handle exception
        }
        finally
        {
            if (Projects is not null)
            {
                ProjectsPending = Projects.Where(f => f.Status.Equals(SD.Status_Pending)).ToList();
                ProjectsApproved = Projects.Where(f => f.Status.Equals(SD.Status_Approved)).ToList();
                ProjectsRejected = Projects.Where(f => f.Status.Equals(SD.Status_Rejected)).ToList();
                ProjectsCompleted = Projects.Where(f => f.Status.Equals(SD.Status_Completed)).ToList();
                ProjectsWaiting = Projects.Where(f => f.Status.Equals(SD.Status_Waiting)).ToList();
            }
        }

        StateHasChanged();
    }

    private async Task CreateProject(ProjectDTO model)
    {
        try
        {
            Project project = new()
                {
                    UserId = UserId,
                    Number = await ProjectRepo.GetTotalCountAsync() + 1,
                    Name = model.Name,
                    ClientId = model.ClientId,
                    OperationUserId = model.OperationUserId,
                    Status = SD.Status_Pending,
                    Phase = SD.GetPhaseInfo(SD.PhasesEnum.Initiation),
                    Date = model.Date,
                    DueDate = model.DueDate,
                    InvoiceDate = model.InvoiceDate,
                    Version = 1
                };

            await ProjectRepo.CreateAsync(project);
            ToastService.Notify(new(ToastType.Success, "Project Created", $"The project '{project.Name}' has been created successfully."));

            await GetProjects();
        }
        catch (Exception ex)
        {
            // handle exception
            Console.WriteLine($"An error occurred: {ex.Message}");
            ToastService.Notify(new(ToastType.Danger, $"Error: {ex.Message}."));
        }
    }
}
